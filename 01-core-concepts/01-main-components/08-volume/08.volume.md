```yaml
title: "Volume"
linkTitle: "Volume"
weight: 11
version: 1.0
type: "docs"
description: >
```

### vol

![](../08-volume/vol1.png)

Data Storage - rozwiÄ…zuje problem restartu poda, zachowania danych podczas jego usÃ³wania i odzyskiwania w momencie jego tworzenia.

Jest to fisyczny storage podÅ‚aczony do servera (ec2). To moÅ¼e byÄ‡ lokalny storace serwera lub zewnÄ™trzny, po za klastrem k8s.

![vol](../08-volume/vol.png)

zapewnie:
- przestrze robocze dla podÃ³w
- wspdzielenie systemu plikw dla kontenerw w tym samym podzie
- przechowuje dane (nawer o restarcie poda sÄ… one dostÄ™pne)
  

  pod moze uÅ¼ywac wiele voluminÃ³w
  po usunieciu oda usuwamy jest volumin efemeryczny ale nie pvc

  voluminy sÄ… montowane w okreÅ›lonych Å›cieÅ¼kach w systemie plkÃ³w  
  !!! Dla kaÅ¼dego kontenera zdefiniowanego w podzie naleÅ¼y niezaleÅ¼nie okreÅ›liÄ‡ miejsce zamontowania kaÅ¼dego woluminu uÅ¼ywanego przez kontener. 
  Woluminy nie mogÄ… byÄ‡ montowane w innych woluminach !!!

  The Kubernetes project suggests that you use the AWS EBS third party storage driver instead.

  The cephfs in-tree storage driver was deprecated in the Kubernetes v1.28 release and then removed entirely in the v1.31 release.

  ## configMap
  ConfigMap umoÅ¼liwia wstrzykiwanie danych konfiguracyjnych do kontenerÃ³w. Do danych przechowywanych w ConfigMap moÅ¼na odwoÅ‚ywaÄ‡ siÄ™ w woluminie typu, aconfigMap nastÄ™pnie wykorzystywaÄ‡ je w konteneryzowanych aplikacjach dziaÅ‚ajÄ…cych w kontenerze.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: configmap-pod
spec:
  containers:
    - name: test
      image: busybox:1.28
      command: ['sh', '-c', 'echo "The app is running!" && tail -f /dev/null']
      volumeMounts:
        - name: config-vol
          mountPath: /etc/config
  volumes:
    - name: config-vol
      configMap:
        name: log-config
        items:
          - key: log_level
            path: log_level.conf
```

## emptyDir
Wszystkie kontenery w Podzie mogÄ… odczytywaÄ‡ i zapisywaÄ‡ te same pliki w emptyDirwoluminie, chociaÅ¼ wolumin ten moÅ¼e byÄ‡ montowany w tych samych lub rÃ³Å¼nych Å›cieÅ¼kach w kaÅ¼dym kontenerze.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-pd
spec:
  containers:
  - image: registry.k8s.io/test-webserver
    name: test-container
    volumeMounts:
    - mountPath: /cache
      name: cache-volume
  volumes:
  - name: cache-volume
    emptyDir:
      sizeLimit: 500Mi
```

wtkoÅ¼ystywany jako cache, buffer aplikacji, pliki tymczasowe, suÅ¼y do wymiany danych pomiÄ™dzy kontenerami.
JeÅ›li nie zostanie okreÅ›lona wartoÅ›Ä‡ `sizeLimit` to Pod moÅ¼e potencjalnie zajÄ…Ä‡ caÅ‚Ä… dostÄ™pnÄ… pamiÄ™Ä‡ efemerycznÄ… (ephemeral storage) wÄ™zÅ‚a.

jeÅ›li okreÅ›lisz: 
```yaml
emptyDir:
  medium: Memory
```
wtedy dane trzymane sÄ… w RAM, nie na dysku â€” przez tmpfs (czyli system plikÃ³w w pamiÄ™ci operacyjnej).

| Cecha                         | `emptyDir`                                         | `hostPath`                                  |
| ----------------------------- | -------------------------------------------------- | ------------------------------------------- |
| Dane trwajÄ… po usuniÄ™ciu Poda | Nie                                                | Tak (dopÃ³ki wÄ™zeÅ‚ istnieje)               |
| ZaleÅ¼ne od wÄ™zÅ‚a              | Nie (tworzy siÄ™ automatycznie na nowym)            | Tak                                       |
| TrwaÅ‚oÅ›Ä‡ danych               | KrÃ³tkotrwaÅ‚a                                       | Lokalna dla wÄ™zÅ‚a                           |
| BezpieczeÅ„stwo                | Bezpieczne                                         | Potencjalnie ryzykowne                      |
| UÅ¼ycie typowe                 | Cache, logi, wspÃ³Å‚dzielone dane miÄ™dzy kontenerami | Logi systemowe, narzÄ™dzia, monitoring hosta |
| Medium                        | Dysk lub RAM (`medium: Memory`)                    | Zawsze dysk hosta                           |
| WpÅ‚yw na hosta                | Å»aden                                              | MoÅ¼e zmieniÄ‡ dane hosta                     |

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: hostpath-example-linux
spec:
  os: { name: linux }
  nodeSelector:
    kubernetes.io/os: linux
  containers:
  - name: example-container
    image: registry.k8s.io/test-webserver
    volumeMounts:
    - mountPath: /foo
      name: example-volume
      readOnly: true
  volumes:
  - name: example-volume
    # mount /data/foo, but only if that directory already exists
    hostPath:
      path: /data/foo # directory location on host
      type: Directory # this field is optional
```

![alt text](image-2.png)
![alt text](image-3.png)

| **WartoÅ›Ä‡ dla type**| **Znaczenie / Zachowanie**                                                                                                                            | **Kiedy uÅ¼ywaÄ‡**                                                                                         |
| ------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| `""` *(pusty ciÄ…g)* | DomyÅ›lna wartoÅ›Ä‡ (brak sprawdzeÅ„). <br> ğŸ”¹ Kubernetes **nie weryfikuje**, co znajduje siÄ™ w tej Å›cieÅ¼ce â€“ moÅ¼e to byÄ‡ katalog, plik, cokolwiek.    | Gdy wiesz, Å¼e Å›cieÅ¼ka na hoÅ›cie **zawsze istnieje**, albo nie zaleÅ¼y Ci, co tam jest.                    |
| `DirectoryOrCreate` | JeÅ›li katalog **nie istnieje**, Kubernetes **utworzy nowy pusty katalog** z uprawnieniami `0755`. <br> ğŸ”¹ WÅ‚aÅ›cicielem bÄ™dzie uÅ¼ytkownik Kubeleta. | Gdy chcesz mieÄ‡ pewnoÅ›Ä‡, Å¼e katalog **zawsze istnieje**, nawet na Å›wieÅ¼ym wÄ™Åºle.                         |
| `Directory`         | Wymaga, Å¼eby katalog **juÅ¼ istniaÅ‚** w tej Å›cieÅ¼ce. <br> JeÅ›li go nie ma â†’ Pod siÄ™ **nie uruchomi**.                                               | Gdy chcesz uÅ¼yÄ‡ **konkretnego katalogu systemowego**, np. `/var/log`.                                    |
| `FileOrCreate`      | JeÅ›li plik **nie istnieje**, Kubernetes **utworzy pusty plik** z uprawnieniami `0644`.                                                             | Gdy chcesz, by Pod zapisywaÅ‚ np. logi w jednym pliku, ktÃ³ry moÅ¼e byÄ‡ tworzony automatycznie.             |
| `File`              | Wymaga, Å¼eby plik **juÅ¼ istniaÅ‚** w danej Å›cieÅ¼ce. <br> JeÅ›li nie istnieje â†’ bÅ‚Ä…d przy starcie Poda.                                               | Gdy chcesz mieÄ‡ pewnoÅ›Ä‡, Å¼e montujesz **konkretny plik konfiguracyjny** lub urzÄ…dzenie.                  |
| `Socket`            | Wymaga, Å¼eby w Å›cieÅ¼ce znajdowaÅ‚o siÄ™ **gniazdo UNIX (socket)**.                                                                                   | Gdy TwÃ³j Pod ma komunikowaÄ‡ siÄ™ z usÅ‚ugÄ… hosta przez socket, np. Docker daemon (`/var/run/docker.sock`). |
| `CharDevice`        | (Linux) Wymaga **urzÄ…dzenia znakowego**, np. `/dev/tty` lub `/dev/null`.                                                                           | Dla aplikacji potrzebujÄ…cych dostÄ™pu do urzÄ…dzeÅ„ znakowych.                                              |
| `BlockDevice`       | (Linux) Wymaga **urzÄ…dzenia blokowego**, np. `/dev/sda`, `/dev/xvdf`.                                                                              | Gdy kontener potrzebuje bezpoÅ›redniego dostÄ™pu do dysku lub partycji.                                    |

### sekret
Wolumin secretsÅ‚uÅ¼y do przesyÅ‚ania poufnych informacji, takich jak hasÅ‚a, do kontenerÃ³w

### csi
Interfejs Container Storage Interface (CSI) definiuje standardowy interfejs dla systemÃ³w koordynacji kontenerÃ³w (takich jak Kubernetes) umoÅ¼liwiajÄ…cy udostÄ™pnianie dowolnym systemom pamiÄ™ci masowej obciÄ…Å¼eÅ„ kontenerowych.
z pvc, z emptyDir

administrator jest oppowiedziaÅ‚ny za wdroÅ¼enie wÅ‚aÅ›ciwej wtyczki CSI dla wybranego srorage.

---

Pod = aplikacja <br/>
PV (PersistentVolume) = dysk fizyczny / storage backend <br/>
PVC (PersistentVolumeClaim) = proÅ›ba o kawaÅ‚ek tego dysku (najczÄ™Å›ciej caÅ‚y kawaÅ‚ek 1:1) <br/>
ConfigMap â†’ dane konfiguracyjne w formie plikÃ³w, <br>
Secret â†’ dane wraÅ¼liwe,<br>
DownwardAPI â†’ dane o samym podzie (np. nazwa, namespace, limity CPU itp.),<br>
emptyDir â†’ tymczasowy katalog,<br>
hostPath â†’ folder z wÄ™zÅ‚a,<br>

DomyÅ›lnie:
1 PV to 1 PVC (1:1)

Ale jeÅ›li masz storage z obsÅ‚ugÄ… RWX (np. NFS, EFS, CephFS), wtedy:
1 PV to wiele PVC / wiele podÃ³w moe robiÄ‡ zapis odczyt ze storaga.

![alt text](image.png)

| Tryb       | Kto moÅ¼e korzystaÄ‡            | Gdzie uÅ¼ywaÄ‡                                 |
| ---------- | ----------------------------- | -------------------------------------------- |
| **RWO** | tylko 1 pod                   | bazy danych, single instance                 |
| **ROX** | wiele podÃ³w, tylko do odczytu | statyczne dane, konfiguracje                 |
| **RWX** | wiele podÃ³w, odczyt i zapis   | wspÃ³Å‚dzielone katalogi, aplikacje skalowalne |

kubernetes nie daje domyÅ›lnie Å¼adngo storage dla poda (po za przestrzeniÄ… noda na  ktÃ³rym pod startuje), ale jest to tymczasowy storage, jest usÃ³wany gdy pod jest restartowany.
Ty jesteÅ› zobowiÄ…zany do utworzenia dedykowanego storage dla poda (ktÃ³ry trwa pojego restarcie) a replika storaga realizowana jest na przynajniej 2 nodach (2 z 3 dostÄ™pnych az) jeÅ‚Å›i wÅ‚aczone zostanie wiÄ™cej replik, wzroÅ›nie letencja dla zapisu (zapis do jednego storaga + replika na 2 pozostaÅ‚e storage)

![alt text](image-1.png)


volumen jet niezaleny od nodw k8s, istnieje po ich restarcie.


## PV - persistence volume
NaleÅ¼y sprawdziÄ‡ status PV aby wiedzieÄ‡ czy zostaÅ‚ juÅ¼ przypisany do PVC lu inne poniÅ¼ej.
![alt text](image-8.png)

## PVC - persistence volume claim

## SC

## CongigMap
Jest lokalnym volumenem, nie jest tworzony prezez PV/PVC, zarzdzany prze kubernetes

## Secret
Jest lokalnym volumenem, nie jest tworzony prezez PV/PVC, zarzdzany prze kubernetes
obiekt typu Secret moÅ¼e (i bardzo czÄ™sto jest) uÅ¼ywany do przechowywania certyfikatÃ³w TLS/SSL, kluczy prywatnych, haseÅ‚, tokenÃ³w itp.
dane przechowywane sÄ… w postaci Base64

jeden pod moze mieÄ‡ podÅ‚aczonych kilka rÃ³Å¼nych volumentÃ³w jednoczeÅ›nie
![alt text](image-4.png)

## storage class
![alt text](image-5.png)

`storagebackend` jest zdefiniowane w Storage Class component po przez atrzybut `provisioner` kaÅ¼dy storebacend ma wÅ‚asny provisioner
internal provisioner provisioner: kubernetes.io/portworx-volume, provisioner: kubernetes.io/aws-ebs ...

Provisioner to komponent, ktÃ³ry tworzy fizyczny wolumen (PV) na podstawie Å¼Ä…dania PVC. PrzykÅ‚ady: <br>
- kubernetes.io/aws-ebs â€“ tworzy dysk EBS w AWS.
- kubernetes.io/gce-pd â€“ tworzy Persistent Disk w Google Cloud.
- kubernetes.io/portworx-volume â€“ uÅ¼ywa Portworx do zarzÄ…dzania wolumenami.
- rbd.csi.ceph.com â€“ provisioner dla Ceph RBD przez CSI.

![alt text](image-6.png)
do kaÅ¼dego provisioningu naleÅ¼y utworzyÄ‡ parametr jakie chemy PV (Storage parameter)

jak trorzony jest pvc w klastrze k8s
![alt text](image-7.png)

jÄ™Å›li chcesz przechowywaÄ‡ dane krÃ³re bÄ™dÄ… trwaÅ‚e ni niezaleÅ¼ne od nodÃ³w k8s musisz uÅ¼yÄ‡ remote storage volume.
jeÅ›li jegnak nie zaleÅ¼y ci na ich trwaÅ‚osci, lepiej uÅ¼uÄ‡ local volume

jednym z lokalnych vloominw jest `hotPath` dostny na pojedyczym nodzie, z przyczyn security powinno siÄ™ go unikaÄ‡

Gdy PVC zostaje przypisany do PV â†’ claimRef jest ustawiony, a status.phase = Bound.
Gdy PVC zostaje usuniÄ™ty â†’ status.phase = Released, ale claimRef nadal istnieje.
Gdy usuniesz claimRef â†’ Kubernetes moÅ¼e zmieniÄ‡ status.phase na Available.

kontroler PersistentVolumeClaim w komponencie Kube Controller Manager realizuje zadania.

1. Monitoruje wszystkie PVC w klastrze.
1. Szuka dostÄ™pnych PV, ktÃ³re:
- majÄ… zgodny storageClassName,
- speÅ‚niajÄ… wymagania accessModes i capacity,
- sÄ… w stanie Available (czyli nie majÄ… claimRef).
1. JeÅ›li znajdzie pasujÄ…cy PV:
- ustawia claimRef w PV,
- zmienia status.phase PV na Bound,
- zmienia status PVC na Bound.


Nazwy `storageClassName` sÄ… dowolne, ale:
MuszÄ… byÄ‡ identyczne (toÅ¼same) miÄ™dzy PV i PVC, Å¼eby doszÅ‚o do powiÄ…zania.
Nie ma znaczenia, czy nazwa to manual, local, fast, slow, ssd, itp. â€” waÅ¼ne, Å¼eby byÅ‚a taka sama w obu obiektach.(moÅ¼e byÄ‡ pustÄ… wartoÅ›ciÄ… ```storageClassName: ""```, ale mysui byÄ‡ !!!)
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: task-pv-volume
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: "/mnt/data"
```

`storageClassName` to etykieta, ktÃ³ra musi siÄ™ zgadzaÄ‡ miÄ™dzy PV i PVC.
W przypadku dynamicznego provisioningu, storageClassName wskazuje na konkretny obiekt `StorageClass`, ktÃ³ry zawiera informacje o tym, jak utworzyÄ‡ PV (np. przez CSI, AWS EBS, itp.).
W przypadku statycznego provisioningu, storageClassName sÅ‚uÅ¼y tylko do dopasowania PV do PVC â€” nie wywoÅ‚uje Å¼adnego provisionera.

UÅ¼ywaj etykiet i selektorÃ³w ktÃ³re umoÅ¼liwoÄ… powiÄ…zanie pv do pvc niezaleÅ¼nie od kolejnosci tworzenia. W ten sposÃ³b unikasz bÅ‚Ä™dnego powiazania.

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-cochise
  labels:
    volume: cochise
spec:
  hostPath:
    path: "/mnt/data/cochise"
  capacity:
    storage: 5Gi
  accessModes:
  - ReadWriteOnce
  storageClassName: ""
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-cochise
spec:
  selector:
    matchLabels:
      volume: cochise
  resources:
    requests:
      storage: 5Gi
  accessModes:
  - ReadWriteOnce
  storageClassName: ""
```
JeÅ¼eli nie uÅ¼ywaÅ‚ byÅ› labeli w pv oraz selectora w pvc, to ti ytworztÅ‚ byÄ‡ najpierw pv-postgres a potem pvc-cochise to etcd je ze sobÄ… powiÄ…ze

Jeeli zachodzi potrzeba zmiany pv / pvc , moÅ¼na to zrobiÄ‡ za pomoca edit 'kubectl edit pv ...' lub poprzez aktualizacjiÄ™ skryptu 'storage: 5Gi -> 6Gi' a nastÄ™pnie 'kubectl replace -f ex-pv.yaml' ps nie zapomnij o zwiekszeniu pvc
